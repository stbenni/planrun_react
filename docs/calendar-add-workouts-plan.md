# План: как пользователь может добавлять тренировки в календарь

**Дата:** 08.02.2026

---

## Целевая модель: «просто календарь»

Вся логика сводится к одной картине:

- Есть **календарь пользователя** — сетка дат.
- На **любой день** можно **задать тренировку** (или оставить день пустым).
- Задать тренировку может:
  - **сам пользователь** (вручную выбрал тип и описание),
  - **тренер** (если в продукте есть роли/доступ),
  - **ИИ** (генерация плана по целям и уровню).

Никаких сущностей «план», «неделя», «фаза» в интерфейсе нет. Есть только **календарь** и **тренировка на дату**. Откуда она появилась (пользователь, тренер, ИИ) — можно хранить как атрибут для отображения и аналитики, но не как отдельную логику.

**API и UX тогда единые:**
- Показать день: `GET день по дате` → что запланировано и что выполнено.
- Задать тренировку на дату: `POST/PUT тренировка на дату` (дата, тип, описание, опционально «кто задал»).
- Удалить тренировку с даты: `DELETE` по дате (или id записи).

Как именно это хранится в БД (одна таблица по датам или текущие `training_plan_weeks` / `training_plan_days`) — деталь реализации. Идеально со временем прийти к модели «одна сущность = одна запись на (user_id, date)» для плановой тренировки, а недели оставить только для отчётов или вообще убрать.

---

## Сейчас в интерфейсе

Для пользователя по-прежнему только **даты**: выбрал дату → видит/добавляет/редактирует тренировку. «Недели» в UI не показываем и не даём их «добавлять» — при добавлении тренировки на дату бэкенд при необходимости сам создаёт служебные записи (например, недели) внутри.

---

## Текущее состояние

### Что уже есть
- **Просмотр дня:** клик по дню → DayModal с планом, упражнениями, списком тренировок (GPX/TCX + ручные из workout_log).
- **Отметить результат:** кнопка «Отметить тренировку» → ResultModal → ввод вручную (дистанция, время, пульс, заметки) или загрузка файла. Данные сохраняются в `workout_log` (action `save_result`).
- **Удаление тренировки:** в DayModal обрабатывается кнопка удаления (action `delete_workout`).
- **Кнопка «Добавить тренировку»:** в DayModal по клику на «Добавить тренировку» показывается `alert('Функция добавления тренировки будет реализована')` — логика не реализована.

### Backend (уже есть)
| Действие | API | Назначение |
|----------|-----|------------|
| Добавить день в план | `add_training_day` | Запись в `training_plan_days`. Сейчас требует `week_id`, `day_of_week` (1–7), `type`, опционально `description`, `date`, `is_key_workout`. |
| Сохранить результат | `save_result` | Запись/обновление в `workout_log` (ручная тренировка или результат по плану). |
| Загрузить файл | (через ResultModal) | Импорт GPX/TCX на выбранную дату. |

Внутренне в БД план хранится как **недели** (`training_plan_weeks`) и **дни в неделях** (`training_plan_days` с `week_id`, `day_of_week`). Для пользователя это скрыто: он работает только с датами.

### Чего не хватает
1. **API «добавить тренировку на дату»:** один запрос с `date` + `type` + `description?` + `is_key_workout?`. Бэкенд по дате находит понедельник недели, при необходимости создаёт запись недели, вычисляет `day_of_week` и создаёт день. Фронт тогда не работает с `week_id` и «неделями» вообще.
2. Во фронте нет вызова добавления планового дня (и не нужен `week_id` в ответе плана, если сделаем API по дате).
3. Нет UI: модальное окно «Добавить тренировку» (тип, описание) для выбранной даты.

---

## Сценарии добавления тренировок

### Сценарий 1: Добавить запланированную тренировку на дату
**Кто:** любой пользователь.  
**Что:** в календаре выбрана дата → пользователь хочет запланировать на неё тренировку (например, «Лёгкий бег 5 км»). Неважно, есть ли уже «неделя» в плане — это решает бэкенд.

**Шаги:**
1. Открыть календарь (вид «неделя» или «месяц»).
2. Выбрать дату (клик по ячейке/карточке).
3. В DayModal нажать «Добавить тренировку» (вместо текущего alert).
4. Открывается модалка «Добавить тренировку»:
   - Тип: Лёгкий бег, Длительный, Темп, Интервалы, ОФП, Отдых и т.д. (easy, long, tempo, interval, …).
   - Описание (опционально): например «5 км в лёгком темпе».
   - Ключевая тренировка (чекбокс, опционально).
5. Отправка: один запрос с **датой** выбранного дня + тип + описание + is_key_workout. Бэкенд по дате сам находит или создаёт неделю, считает день недели и создаёт запись в `training_plan_days`. После успеха — закрыть модалку, обновить данные дня и плана.

Никакого «добавления недели» или выбора недели пользователь не делает — только дата и тип тренировки.

### Сценарий 2: Добавить ручную тренировку (результат) на дату
**Кто:** пользователь без плана или хочет зафиксировать пробежку на день, который не в плане.  
**Что:** «Сегодня я пробежал 5 км» — только факт, без привязки к плановому дню.

**Уже есть:** ResultModal + `save_result` — пользователь может открыть день, нажать «Отметить тренировку» и ввести дистанцию/время. Запись попадает в `workout_log` и отображается как ручная тренировка. То есть **добавить «результат» / ручную тренировку на день уже можно**.

**Улучшения (по желанию):**
- Явная кнопка «Отметить тренировку» на день без плана (тот же ResultModal).
- Быстрый вход «Отметить тренировку сегодня» с дашборда или календаря.

### Сценарий 3: Загрузить тренировку из файла (GPX/TCX)
**Кто:** пользователь с треком с часов/приложения.  
**Что:** в DayModal выбрать день → «Загрузить файл» (или «Отметить тренировку» → «Из файла») → загрузка GPX/TCX, привязка к дате.

**Текущее состояние:** в ResultModal есть выбор «Из файла» и загрузка. Нужно проверить, что после загрузки запись привязывается к выбранной дате и отображается в календаре.

---

## Рекомендуемый порядок реализации

### Этап 1: Добавить тренировку на дату (Сценарий 1)
1. **Backend:** новый action (например, `add_training_day_by_date`) или расширение `add_training_day`: принимает **date** (обязательно), **type**, **description?**, **is_key_workout?**. Логика:
   - По дате вычислить понедельник недели (start_date).
   - Найти в `training_plan_weeks` запись с этим user_id и start_date; если нет — создать (INSERT недели с week_number = MAX+1 или по дате).
   - Вычислить day_of_week (1–7) из даты.
   - INSERT в `training_plan_days` (user_id, week_id, day_of_week, type, description, date, is_key_workout). Инвалидировать кеш плана.
2. **Frontend — ApiClient:** метод `addTrainingDayByDate({ date, type, description?, is_key_workout? })`, вызывающий новый action.
3. **Frontend — модалка «Добавить тренировку»:** компонент с полями тип, описание, чекбокс «Ключевая». При отправке передаётся только дата (выбранного дня) + эти поля.
4. **DayModal:** по клику «Добавить тренировку» открывать эту модалку; после успеха — закрыть, перезапросить getDay и при необходимости план.
5. Кнопку «Добавить тренировку» показывать когда на выбранную дату можно добавить план (например, день пустой или отдых — по желанию разрешить и перезапись).

### Этап 2: Удобство для ручных тренировок (Сценарий 2)
- В DayModal для дня без плана явно показывать «Отметить тренировку» (ResultModal).
- Опционально: кнопка «Отметить тренировку сегодня» на дашборде/в календаре.

### Этап 3: Загрузка файла (Сценарий 3)
- Проверить ResultModal + загрузка GPX/TCX: привязка к выбранной дате, появление в getDay. Доработать при необходимости.

---

## Структура данных (напоминание)

**Целевая модель в коде/БД:** одна сущность «тренировка на дату»: (user_id, date, type, description, кто задал?, упражнения, результат…). Недели не обязательны.

**Сейчас в БД:**
- **training_plan_weeks** — служебная группировка; при упрощении можно перестать опираться на неё в основном потоке или убрать.
- **training_plan_days** — по сути «тренировка на дату» (есть user_id, date, type, description); привязан к week_id для исторической структуры. Достаточно везде работать по **date**.
- **workout_log** — факт выполнения (результат): дата, дистанция, время, темп, заметки.

Типы тренировки (type): `rest`, `easy`, `long`, `tempo`, `interval`, `fartlek`, `marathon`, `control`, `race`, `other`, `free`. Опционально можно добавить поле «источник» (user / coach / ai) для отображения и аналитики.

---

## Итог

| Сценарий | Что нужно | Приоритет |
|----------|-----------|-----------|
| Добавить запланированную тренировку **на дату** | API по дате (add_training_day_by_date или расширение add_training_day), ApiClient, AddTrainingModal, врезка в DayModal | 1 |
| Отметить ручную тренировку на дату | Уже есть (ResultModal + save_result); при желании — явные кнопки, «Отметить сегодня» | 2 |
| Загрузить GPX/TCX на дату | Проверить/доработать текущий поток | 3 |

«Добавление недели» как отдельное действие пользователю не нужно: при добавлении тренировки на любую дату бэкенд при необходимости сам создаёт запись недели.
