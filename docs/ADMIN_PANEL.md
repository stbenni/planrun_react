# Панель администратора

Админка позволяет управлять **пользователями** и **настройками сайта**. Доступ только у пользователей с ролью `admin`.

## Как выдать себе роль admin

В БД в таблице `users` установите поле `role` в значение `admin` для нужного пользователя:

```sql
UPDATE users SET role = 'admin' WHERE username = 'ваш_логин';
```

После этого перелогиньтесь или обновите страницу.

## Открытие админки

- В веб-интерфейсе: меню профиля (аватар) → **Админка** (пункт виден только администраторам).
- Прямой URL: `/admin`.

## Разделы

### Пользователи

- Список с пагинацией и поиском по логину/email.
- Смена роли: пользователь, тренер, администратор.
- Удаление пользователя (кроме себя). Удаляются **все** связанные данные:
  - планы и структура плана (недели, дни, упражнения дней, фазы);
  - прогресс тренировок (`training_progress`);
  - ручные тренировки (`workout_log`);
  - точки треков автоматических тренировок (`workout_timeline`);
  - автоматические тренировки (`workouts`);
  - токены сброса пароля и JWT refresh-токены;
  - связи тренер–ученик (`user_coaches`, если таблица есть);
  - файл аватара на диске;
  - кеш пользователя. Затем удаляется запись в `users`.

### Настройки сайта

- **Название сайта** — отображаемое имя.
- **Описание сайта** — краткое описание.
- **Режим обслуживания** — при включении сайт можно считать «на обслуживании» (логика блокировки на фронте при необходимости).
- **Регистрация включена** — разрешить/запретить регистрацию новых пользователей (логику проверки при регистрации можно добавить по этому флагу).
- **Email для связи** — контактный email.

Настройки хранятся в таблице `site_settings`. Если таблицы нет, создайте её:

```bash
cd planrun-backend
php scripts/migrate_site_settings.php
```

## API (только для role = admin)

| Действие | Метод | Параметры |
|----------|--------|-----------|
| Список пользователей | GET | `action=admin_list_users`, `page`, `per_page`, `search` |
| Один пользователь | GET | `action=admin_get_user`, `user_id` |
| Обновить пользователя | POST | `action=admin_update_user`, body: `user_id`, `role` или `email`, `csrf_token` |
| Удалить пользователя | POST | `action=delete_user`, body: `user_id`, `csrf_token` |
| Получить настройки | GET | `action=admin_get_settings` |
| Сохранить настройки | POST | `action=admin_update_settings`, body: `csrf_token`, `settings` (объект) |

## Безопасность

- Все действия админки проверяют `role === 'admin'` на бэкенде.
- Для изменений (обновление пользователя, настроек, удаление) требуется CSRF-токен (как и для остальных POST-запросов приложения).
