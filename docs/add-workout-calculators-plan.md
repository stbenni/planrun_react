# Добавление тренировок: калькуляторы и выбор типов (по мотивам planrun)

**Цель:** сделать в нашем проекте (vladimirov) UX добавления тренировки похожим на planrun: выбор категории → тип → конструктор/калькулятор или библиотека упражнений, в стиле нашего сайта и с нашим API.

---

## Как устроено в planrun

### 1. Двухшаговый поток

- **Шаг 1 — выбор категории:** три карточки:
  - **Бег** (running) — лёгкий, темповый, интервалы, фартлек, длительный, контрольная
  - **ОФП** (ofp) — общая физическая подготовка
  - **СБУ** (sbu) — специальные беговые упражнения

- **Шаг 2 — форма добавления:**
  - Скрывается выбор категории, показывается форма.
  - Поле **тип тренировки** (select) заполняется в зависимости от категории.
  - Кнопка «← Назад к выбору категории».

### 2. Конструктор для бега (run constructor)

Для категории **Бег** после выбора типа показывается один из блоков:

- **Простые типы** (easy, tempo, long, race):
  - Дистанция (км)
  - Длительность (ч:мм:сс или время)
  - Темп (мин/км, например 5:30)
  - Пульс (уд/мин или зона, например 140–150)
  - **Калькулятор:** при изменении любых двух из (дистанция, время, темп) третье пересчитывается автоматически:
    - время = дистанция × темп
    - темп = время / дистанция
    - дистанция = время / темп
  - Маска ввода для темпа (MM:SS), парсинг времени (HH:MM:SS и MM:SS).
  - По полям генерируется текст описания в textarea (например: «Легкий бег: 5 км, темп 5:30, пульс 140–150»).

- **Интервалы** (interval):
  - Разминка: дистанция/длительность, темп.
  - Основная часть: количество повторов, дистанция интервала (м) или длительность (мин), темп, пульс.
  - Пауза: дистанция/длительность, тип (трусцой, ходьбой, отдых).
  - Заминка: дистанция/длительность, темп.
  - Описание собирается в текст (например: «Разминка: 2 км. 5×1000м в темпе 4:00, пауза 400м трусцой. Заминка: 2 км»).

- **Фартлек** (fartlek):
  - Разминка и заминка (как выше).
  - Динамические сегменты ускорений: «Добавить сегмент» — в каждом сегменте: кол-во повторов, дистанция/длительность ускорения, темп, пульс, восстановление (дистанция/время, тип: трусца/ходьба/лёгкий бег).
  - Описание генерируется из сегментов.

### 3. ОФП и СБУ — библиотека упражнений

- Для категорий **ОФП** и **СБУ** вместо конструктора показывается список упражнений из **библиотеки** (API `list_exercise_library&category=ofp|sbu`).
- Пользователь отмечает чекбоксами нужные упражнения.
- Текст описания формируется из названий и параметров выбранных упражнений (или подставляется в textarea).
- В planrun после сохранения дня при необходимости вызывается `add_day_exercise` для каждого выбранного упражнения (plan_day_id возвращается при добавлении дня).

### 4. Отправка

- Форма отправляет: date, type, description, is_key_workout (и category в planrun).
- В planrun используется `add_training_day` (старый API с week_id/day_of_week), у нас — `add_training_day_by_date` (дата + тип + описание).

---

## Что уже есть у нас (vladimirov)

- **API:**
  - `add_training_day_by_date` — дата, type, description?, is_key_workout? → создаётся день, возвращается day_id.
  - `list_exercise_library` — GET, опционально по category (run, ofp, sbu или наши: run, strength, cardio, flexibility, other — см. ExerciseValidator).
  - `add_day_exercise` — POST, plan_day_id, category, name, sets?, reps?, distance_m?, duration_sec?, weight_kg?, pace?, notes? (нужен CSRF).

- **Фронт:**
  - AddTrainingModal: один шаг — тип (select из фиксированного списка), описание (textarea), чекбокс «Ключевая тренировка». Без выбора категории и без калькуляторов.

- **Стиль:** наш дизайн (кнопки .btn, .card, тёмная тема, Modal из common).

---

## План реализации в нашем проекте

### Этап 1: Выбор категории и типы по категории

1. В AddTrainingModal сделать **два шага** (как в planrun, но в нашем UI):
   - Шаг 1: три карточки — **Бег**, **ОФП**, **СБУ** (иконка + название + краткое описание). При выборе — переход к шагу 2, запомнить category (running / ofp / sbu).
   - Шаг 2: форма с кнопкой «← Назад к выбору категории» и select «Тип тренировки», заполняемый в зависимости от category:
     - running → easy, tempo, interval, fartlek, long, race
     - ofp → other
     - sbu → sbu
   - Остальные поля (описание, ключевая) остаются на шаге 2.

2. Стиль карточек категорий — в духе нашего сайта (например .card, .card--interactive из cards.css), без копирования верстки planrun 1:1.

### Этап 2: Калькулятор для простых беговых типов

1. Для категории **Бег** и типов **easy, tempo, long, race** показывать блок «Параметры бега»:
   - Дистанция (км), число, step 0.1.
   - Длительность: input time (HH:MM:SS) или отдельные часы/минуты/секунды.
   - Темп (мин/км): текст MM:SS, маска/парсинг как в planrun (опционально).
   - Пульс: текст (например 140–150 или зона).

2. Логика калькулятора (при изменении любого из полей):
   - Из любых двух из (дистанция, время, темп) вычислять третье:
     - время = дистанция × темп (в минутах);
     - темп = время / дистанция;
     - дистанция = время / темп.
   - Формат времени у нас можно оставить HH:MM:SS или упростить до «минуты» (число) для первого варианта.

3. Автозаполнение поля «Описание» из этих полей (например: «Легкий бег: 5 км, темп 5:30, пульс 140–150»), с возможностью править текст вручную.

### Этап 3: Конструктор интервалов и фартлека

1. **Интервалы (interval):**
   - Секции: Разминка, Основная часть, Заминка.
   - Разминка/заминка: дистанция (км) или длительность (мин), темп (опционально).
   - Основная: количество повторов, дистанция интервала (м) или длительность (мин), темп, пульс; пауза — дистанция/длительность, тип (трусцой/ходьбой/отдых).
   - Генерация описания в textarea (как в planrun).

2. **Фартлек (fartlek):**
   - Разминка/заминка (как выше).
   - Список сегментов: кнопка «Добавить сегмент». В сегменте: повторы, дистанция/длительность ускорения, темп, пульс, восстановление (дистанция/время, тип).
   - Сбор текста описания из сегментов.

3. Стиль — наши формы (.form-group, .add-training-*), компактно и в одном модальном окне (скролл при необходимости).

### Этап 4: Библиотека упражнений для ОФП и СБУ

1. Для категорий **ОФП** и **СБУ** после выбора типа показывать не только textarea, но и блок «Упражнения из библиотеки»:
   - Запрос к нашему API `list_exercise_library` (с параметром category: ofp / sbu, если API поддерживает; иначе фильтрация на фронте по категории).
   - Список карточек/чекбоксов: название, параметры (подходы×повторы, вес, дистанция и т.д.).
   - При выборе упражнений — подставлять в описание их названия и параметры (или формировать список для последующей отправки).

2. Опционально (позже): после успешного `add_training_day_by_date` получать `day_id` и вызывать `add_day_exercise` для каждого выбранного упражнения из библиотеки, чтобы в календаре отображались структурированные упражнения дня. Иначе пока достаточно текста в description.

### Этап 5: Унификация и полировка

- Маска темпа (MM:SS), валидация времени и дистанций.
- Адаптив под мобильные (наши брейкпоинты).
- Тёмная тема для новых блоков.
- Не дублировать логику с planrun: переиспользовать только идеи; код и API — наши.

---

## Технические заметки

- **API:** все вызовы через наш ApiClient; для `add_day_exercise` и мутирующих — получать CSRF и передавать в теле.
- **Состояние модалки:** шаг (1 — категория, 2 — форма), category, type, поля калькулятора/конструктора, выбранные упражнения из библиотеки. При закрытии модалки сбрасывать.
- **Описание:** при наличии конструктора/калькулятора описание можно хранить в state и синхронизировать с textarea (автогенерация + ручное редактирование).
- **Категории в API упражнений:** в ExerciseValidator указаны run, strength, cardio, flexibility, other. Для отображения «ОФП»/«СБУ» можно маппить ofp → other (или strength), sbu → other; при вызове list_exercise_library уточнить, есть ли фильтр по category и какие значения принимает бэкенд/таблица exercise_library.

---

## Итог

Сделать добавление тренировки в нашем проекте похожим на planrun: выбор категории (Бег / ОФП / СБУ) → выбор типа → для бега калькулятор (дистанция/время/темп) и при необходимости конструкторы интервалов и фартлека с автогенерацией описания → для ОФП/СБУ выбор из библиотеки упражнений. Всё на нашем API (`add_training_day_by_date`, `list_exercise_library`, при необходимости `add_day_exercise`) и в стиле нашего сайта.
