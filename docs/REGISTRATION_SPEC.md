# Спецификация регистрации PlanRun

Документ для интеграции и агентов: полное описание потока регистрации, полей, валидации и данных. Прочитав его, агент должен понимать, как работает регистрация и какие данные доступны на каждом этапе.

---

## 1. Обзор

- **Назначение:** создание учётной записи пользователя и (опционально) генерация плана тренировок.
- **Фронтенд:** React, многошаговая форма (`RegisterScreen.jsx`). Точки входа: страница `/register` или модальное окно с лендинга.
- **Бэкенд:** PHP `planrun-backend/register_api.php`. Вызов с фронта идёт через обёртку `api/register_api.php` (CORS, сессия), которая подключает логику из бэкенда.
- **После успеха:** автологин (PHP-сессия), редирект на `/` с сообщением о генерации плана.

---

## 2. API

### 2.1 Базовый URL и метод

- **Регистрация (POST):** клиент шлёт запрос на `POST /api/register_api.php` (тело — JSON).
- **Валидация поля (GET):** `GET /api/register_api.php?action=validate_field&field=<name>&value=<value>`.

Тело POST принимается как `application/json` или `application/x-www-form-urlencoded` (фоллбэк на `$_POST`).

### 2.2 Валидация поля (GET)

- **action:** `validate_field`.
- **Параметры:** `field` (имя поля), `value` (значение).
- **Поддерживаемые поля:** `username`, `email`.
- **Ответ:** `{ "valid": true|false, "message": "..." }` (UTF-8).

Правила:
- **username:** не пустой, 3–50 символов, паттерн `[a-zA-Z0-9_а-яА-ЯёЁ\s-]+`, уникален в `users`.
- **email:** не пустой, валидный email, уникален в `users` (где email не пустой).

### 2.3 Регистрация (POST)

- **Успех:** `{ "success": true, "message": "...", "plan_message": "...", "user": { "id", "username", "email" } }`.
- **Ошибка:** `{ "success": false, "error": "..." }`.

После успеха на бэкенде вызывается `session_start()` (если ещё не было), в сессию пишутся `authenticated`, `user_id`, `username`, `login_time` — пользователь считается авторизованным.

---

## 3. Режимы и цели (conditional logic)

Обязательные и опциональные поля зависят от выбора пользователя.

### 3.1 Режим тренировок (`training_mode`)

| Значение  | Описание на фронте        | Поведение бэкенда |
|-----------|---------------------------|-------------------|
| `ai`      | AI-тренер (рекомендуем)   | Генерация плана через PlanRun AI (фоновый скрипт). |
| `self`    | Самостоятельно            | Шаг «Цель» не показывается. Создаётся пустой календарь. Часть полей не показывается и не обязательна. |
| `coach`   | Живой тренер (пока «Скоро»)| На бэкенде обрабатывается как `ai`. |
| `both`    | AI + тренер               | Как `ai` (генерация плана). |

Для `self` в БД принудительно сохраняется `goal_type = 'health'`; цель пользователь не выбирает.

### 3.2 Цель (`goal_type`)

Имеет смысл только при режиме **не** `self` (шаг 2 на фронте).

| Значение           | Описание              | Обязательные поля по цели |
|--------------------|-----------------------|----------------------------|
| `health`           | Бегать для здоровья   | `health_program`; при `health_program === 'custom'` — `health_plan_weeks`. |
| `race`             | Подготовка к забегу   | Хотя бы одно: `race_date` или `target_marathon_date`. |
| `time_improvement` | Улучшить время        | Хотя бы одно: `target_marathon_date` или `race_date`. |
| `weight_loss`      | Снижение веса         | `weight_goal_kg`, `weight_goal_date`. |

Для всех целей (кроме `self`) обязательны также: `goal_type`, `training_start_date`, пол, при не-self — нормализованный `experience_level` (см. ниже).

---

## 4. Шаги формы (фронтенд)

- **Шаг 0:** Выбор режима — `ai` | `self` | (coach disabled). При выборе `self` следующий шаг — 3 (профиль), иначе — 1.
- **Шаг 1:** Аккаунт — `username`, `password`, `email`. Валидация через API `validate_field` для username и email.
- **Шаг 2:** Только если режим не `self`. Цель + поля по цели + дата начала тренировок.
  - При `health`: выбор программы, при `custom` — срок плана.
  - При `race` / `time_improvement`: дата забега (для race обязательна в HTML), целевое время; для time_improvement дата марафона можно в том же поле.
  - При `weight_loss`: целевой вес, дата достижения.
  - Общее: `training_start_date` обязательна.
- **Шаг 3:** Профиль. Для всех: пол. Для `self`: дополнительно только «Дата начала тренировок» (опционально, по умолчанию следующий понедельник). Для не-`self`: год рождения, рост, вес, опыт (`experience_level`), объём/неделя, дни бега и ОФП, ОФП-предпочтения, время тренировок, беговая дорожка, здоровье, устройство; при целях race/time_improvement — расширенный блок (темп, первый забег, последний результат).

Отправка формы — на шаге 3 по кнопке «Создать аккаунт»; данные собираются из `formData` и уходят одним POST.

---

## 5. Матрица обязательных полей (бэкенд)

Условная обязательность (conditional required):

| Режим   | Цель  | Обязательные поля (кроме общих) |
|---------|-------|----------------------------------|
| **self**| —     | Только: `username`, `password`, `email`, `gender` (если не указан — подставляется `male`). `experience_level` не требуется, в БД пишется NULL. Дата начала опциональна; при создании пустого плана при отсутствии даты используется текущая дата. |
| ai/both | health| `goal_type`, `training_start_date`, `health_program`; при `health_program === 'custom'` — `health_plan_weeks`. Пол, опыт (или дефолт `beginner`). |
| ai/both | race | `goal_type`, `training_start_date`, хотя бы одно: `race_date` или `target_marathon_date`. Пол, опыт. |
| ai/both | time_improvement | То же, что для race (одна из двух дат). Пол, опыт. |
| ai/both | weight_loss | `goal_type`, `training_start_date`, `weight_goal_kg`, `weight_goal_date`. Пол, опыт. |

Общие обязательные для всех сценариев: `username` (3–50 символов, уникален), `password` (≥6 символов), `email` (валидный, уникален). Для не-`self` обязателен пол (`gender`).

---

## 6. Справочник полей (запрос → БД)

Ниже — поля, которые фронт может отправить и которые бэкенд записывает в БД. Типы и допустимые значения соответствуют текущей реализации.

### 6.1 Аккаунт и идентификация

| Поле           | Тип (БД/запрос) | Обязательность | Описание |
|----------------|------------------|----------------|---------|
| `username`     | string           | всегда         | 3–50 символов, буквы/цифры/пробелы/дефис/подчёркивание, уникален. |
| `password`     | string           | всегда         | ≥6 символов, на бэкенде хранится хэш (`password_hash`, PASSWORD_DEFAULT). |
| `email`        | string / NULL    | всегда         | Валидный email, уникален. Может нормализоваться в NULL при пустой строке. |
| `role`         | string           | всегда (бэкенд)| Фиксировано `user`. |
| `username_slug`| string           | всегда (бэкенд)| Генерируется из `username` (нижний регистр, не-буквоцифры → `_`); при коллизии суффикс `_1`, `_2`, … |

### 6.2 Цель и даты

| Поле                    | Тип      | Когда обязателен | Описание |
|-------------------------|----------|-------------------|----------|
| `goal_type`             | string   | при не-self       | `health` \| `race` \| `weight_loss` \| `time_improvement`. Для `self` в БД принудительно `health`. |
| `race_date`             | date     | для race — одна из дат | Дата забега (YYYY-MM-DD). |
| `target_marathon_date`  | date     | для time_improvement — одна из дат | Дата марафона. |
| `race_target_time`      | time     | нет               | Целевое время забега (HH:MM:SS или HH:MM). |
| `target_marathon_time`  | time     | нет               | Целевое время марафона. |
| `training_start_date`   | date     | при не-self       | Дата начала тренировок. Для `self` опциональна (дефолт при создании плана — сегодня). |
| `race_distance`         | string   | нет               | `5k` \| `10k` \| `half` \| `marathon` или пусто. |
| `weight_goal_kg`        | float    | при weight_loss   | Целевой вес (кг). |
| `weight_goal_date`      | date     | при weight_loss   | Дата достижения цели по весу. |
| `health_program`        | string   | при health (не self) | `start_running` \| `couch_to_5k` \| `regular_running` \| `custom`. |
| `health_plan_weeks`     | int      | при health + custom | Срок плана в неделях (число). |
| `current_running_level` | string   | нет (для health при не-self дефолт `basic`) | `zero` \| `basic` \| `comfortable`. Для `self` при отсутствии подставляется `basic`. |

### 6.3 Профиль

| Поле                 | Тип        | Когда обязателен | Описание |
|----------------------|------------|-------------------|----------|
| `gender`             | string     | всегда (для self дефолт `male` если пусто) | `male` \| `female`. |
| `birth_year`         | int / NULL | нет               | Год рождения. |
| `height_cm`          | int / NULL | нет               | Рост (см). |
| `weight_kg`          | float/NULL | нет               | Вес (кг). |
| `experience_level`   | string/NULL| при не-self       | `novice` \| `beginner` \| `intermediate` \| `advanced` \| `expert`. Для `self` не показывается и в БД сохраняется **NULL** (колонка должна допускать NULL). |
| `weekly_base_km`     | float/NULL | нет               | Текущий недельный объём (км). |
| `sessions_per_week`  | int / NULL | нет               | Количество тренировок в неделю; на фронте может выводиться из длины `preferred_days`. |
| `preferred_days`     | JSON array | нет               | Массив дней бега, напр. `["mon","wed","fri"]`. Ключи: `mon`–`sun`. |
| `preferred_ofp_days` | JSON array | нет               | Дни ОФП в том же формате. |
| `has_treadmill`      | 0|1       | нет               | Есть ли беговая дорожка. |
| `ofp_preference`     | string     | нет               | `gym` \| `home` \| `both` \| `group_classes` \| `online`. |
| `training_time_pref`| string     | нет               | `morning` \| `day` \| `evening`. |
| `health_notes`       | string     | нет               | Текст о здоровье. |
| `device_type`        | string     | нет               | Тип устройства (на фронте в регистрации не отправляется, `device_type: undefined`). |
| `training_mode`      | string     | всегда            | `ai` \| `self` \| `coach` \| `both` (coach на бэкенде трактуется как ai). |

### 6.4 Расширенный профиль (забеги)

| Поле                        | Тип        | Описание |
|-----------------------------|------------|----------|
| `easy_pace_sec`             | int / NULL | Комфортный темп в с/км (180–600). Может считаться из `easy_pace_min` (MM:SS). |
| `easy_pace_min`             | string     | Только на фронте/расчёт; на бэкенде конвертируется в `easy_pace_sec` при необходимости. |
| `is_first_race_at_distance` | 0|1| Первый забег на эту дистанцию. Для `self` при отсутствии подставляется 0. |
| `last_race_distance`        | string     | `5k` \| `10k` \| `half` \| `marathon` \| `other`. |
| `last_race_distance_km`     | float      | При `last_race_distance === 'other'`. |
| `last_race_time`            | time       | Время последнего забега. |
| `last_race_date`            | date       | Если с фронта приходит месяц (YYYY-MM), на бэкенде дополняется до YYYY-MM-01. |
| `running_experience`        | string     | `less_3m` \| `3_6m` \| `6_12m` \| `1_2y` \| `more_2y`. |

---

## 7. Валидация на бэкенде (сообщения об ошибках)

- `Имя пользователя и пароль обязательны`
- `Пароль должен быть не менее 6 символов`
- `Email обязателен` / `Некорректный формат email`
- `Пожалуйста, выберите пол` (при не-self)
- `Тип цели обязателен` (при не-self)
- `Дата начала тренировок обязательна` (при не-self)
- `Укажите дату забега или целевую дату` (goal race)
- `Укажите дату марафона или дату забега` (goal time_improvement)
- `Целевой вес обязателен` / `Дата достижения цели обязательна` (weight_loss)
- `Программа тренировок обязательна` (health)
- `Срок плана обязателен для своей программы` (health + custom)
- `Регистрация отключена администратором` (если в `site_settings` значение `registration_enabled` = '0')
- `Пользователь с таким именем уже существует`
- Ошибки БД/подготовки запроса возвращаются в поле `error`.

---

## 8. База данных

### 8.1 Таблицы, задействованные при регистрации

- **users** — одна строка на пользователя. Все поля из раздела 6 записываются в эту таблицу (в т.ч. `username_slug`, хэш пароля, `role`). Колонка `experience_level` должна допускать NULL (миграция: `scripts/migrate_experience_level_nullable.php`).
- **user_training_plans** — одна строка после регистрации: `user_id`, `start_date = CURDATE()`, `marathon_date` (из цели), `target_time` (из цели), `is_active = FALSE`. После генерации плана (AI или пустой) `is_active` может обновляться на TRUE.

### 8.2 План после регистрации

- **Режим `self`:** вызывается `planrun_ai/create_empty_plan.php` — создаются записи в `training_plan_weeks` и `training_plan_days` (пустые дни типа `rest`). Дата начала: из `training_start_date` или текущая дата. Ответ пользователю: «Пустой календарь создан!»
- **Режим `ai` / `both`:** в фоне запускается `php planrun_ai/generate_plan_async.php <user_id>`. План сохраняется через `plan_saver.php`, затем план активируется. Ответ: «План тренировок генерируется через PlanRun AI. Это займет 3-5 минут.»

---

## 9. Какие данные когда есть

- **До отправки формы:** только введённые на фронте поля в `formData`; при необходимости вызывается `validate_field` для username и email.
- **Сразу после успешного POST:** в ответе — `user: { id, username, email }`, `plan_message`; в PHP-сессии — `user_id`, `username`, `authenticated`, `login_time`. На фронте вызывается `onRegister`, редирект на `/` с `state: { registrationSuccess, planMessage }`.
- **В БД после регистрации:** полная строка в `users` (все поля из раздела 6), одна строка в `user_training_plans`; для `self` — заполненные недели/дни пустого плана; для ai/both — план может появиться позже (асинхронная генерация).
- **Дальнейшая работа с пользователем:** авторизация по сессии или JWT; профиль и план загружаются через API (get_profile, load plan и т.д.).

---

## 10. Файлы для правок и отладки

| Что | Где |
|-----|-----|
| Логика регистрации, валидация, INSERT | `planrun-backend/register_api.php` |
| Обёртка (CORS, сессия) | `api/register_api.php` |
| Форма и шаги | `src/screens/RegisterScreen.jsx` |
| Вызов API регистрации | `src/api/ApiClient.js` — метод `register()` |
| Пустой план для self | `planrun-backend/planrun_ai/create_empty_plan.php` |
| Асинхронная генерация плана | `planrun-backend/planrun_ai/generate_plan_async.php` |
| Миграция experience_level NULL | `planrun-backend/scripts/migrate_experience_level_nullable.php` |

---

## 11. Краткая схема для агента

1. Определить режим (`training_mode`) и при не-self — цель (`goal_type`).
2. По матрице из раздела 5 проверить обязательные поля для этой пары (режим, цель).
3. Убедиться, что опциональные поля либо не переданы, либо в допустимых форматах (см. раздел 6).
4. Для `self` не требовать и не подставлять `experience_level`; в БД писать NULL; для остальных полей при необходимости подставлять дефолты (current_running_level, is_first_race_at_distance, gender).
5. После INSERT в `users` создать запись в `user_training_plans` и в зависимости от режима вызвать создание пустого плана или запуск асинхронной генерации.
6. Установить сессию и вернуть `success`, `user`, `plan_message`.

Документ актуален на момент последнего обновления логики регистрации и полей в `register_api.php` и `RegisterScreen.jsx`.
