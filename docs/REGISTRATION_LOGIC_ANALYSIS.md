# Анализ логики окна регистрации (vladimirov)

## Найденные несовпадения и исправления

### 1. «Первый забег на дистанцию» (is_first_race / is_first_race_at_distance) — исправлено

- **Проблема:** В форме радиокнопка «Да, первый раз» использовала ключ `is_first_race` (checked и onChange), тогда как в `formData` и в отправке на бэкенд используется только `is_first_race_at_distance`. В результате при выборе «Да» значение записывалось в несуществующее в состоянии поле, и на бэкенд всегда уходило «Нет» (0).
- **Бэкенд:** Ожидал только `is_first_race`, фронт отправлял `is_first_race_at_distance`.
- **Исправления:**
  - В `RegisterScreen.jsx`: для обеих радиокнопок используются только `is_first_race_at_distance` (checked и onChange).
  - В `register_api.php`: учёт обоих ключей — `is_first_race_at_distance` и `is_first_race` (для обратной совместимости).

### 2. Сообщение о генерации плана (plan_message) — исправлено

- **Проблема:** Бэкенд возвращает `plan_message`, но `ApiClient.register()` возвращал только `{ success, user }`. В итоге на экране после регистрации всегда показывалось дефолтное «Регистрация успешна!» вместо текста вроде «План тренировок генерируется через PlanRun AI...».
- **Исправление:** В `ApiClient.js` в ответ при успешной регистрации добавлено поле `plan_message: data.plan_message ?? null`.

### 3. Комфортный темп (easy_pace) на бэкенде — исправлено

- **Проблема:** Бэкенд парсил `easy_pace_min` как целое число (в PHP `(int)"7:30"` = 7) и считал секунды как «дополнение к минутам» (0–59), тогда как фронт присылает `easy_pace_sec` уже в виде полного числа секунд на км (180–600). Это давало неверный темп.
- **Исправление:** В `register_api.php` сначала используется присланный `easy_pace_sec` в допустимом диапазоне 180–600; при его отсутствии — разбор строки `easy_pace_min` в формате MM:SS.

### 4. Уровень опыта (experience_level) — исправлено

- **Проблема:** На фронте в форме доступны значения: `novice`, `beginner`, `intermediate`, `advanced`, `expert`. В бэкенде в `register_api.php` допускались только `beginner`, `intermediate`, `advanced`, поэтому выбор «Новичок» или «Опытный» при регистрации приводил к подмене на `beginner`.
- **Исправление:** В `register_api.php` список разрешённых значений расширен до: `novice`, `beginner`, `intermediate`, `advanced`, `expert`.

### 5. Цель «Здоровье» и current_running_level — исправлено

- **Проблема:** При цели «Просто бегать для здоровья» бэкенд требовал обязательное поле `current_running_level`, которого нет в форме регистрации. Регистрация с целью «здоровье» могла падать с ошибкой «Текущий уровень бега обязателен».
- **Исправление:** В `register_api.php` для цели `health` при отсутствии `current_running_level` подставляется значение по умолчанию `'basic'`, проверка на обязательность убрана.

---

## Замечания без изменений кода

- **RegisterModal / onSuccess:** В модалке передаётся `onSuccess`, но `RegisterScreen` при успехе его не вызывает (только `onRegister` и `navigate`). После перехода на другой маршрут модалка размонтируется, поэтому визуально всё ок; при желании можно вызывать `onSuccess?.()` перед `navigate` для единообразия.
- **device_type:** В форме регистрации поле «Устройство/платформа» есть, но в `submitData` оно явно обнуляется (`device_type: undefined`) и на бэкенд не отправляется (по комментарию — «оно в интеграциях»). Либо не показывать поле на шаге регистрации, либо начать его отправлять — решается по продукту.
- **Шаг 0 (режим):** Кнопка «Назад» на шаге 0 не отображается (`step > 0`), переход только по клику на карточку — это согласовано с текущим UX.

---

## Итог

- Исправлены: привязка радиокнопки «Первый забег» к `is_first_race_at_distance`, проброс `plan_message` из API в клиент, расчёт `easy_pace_sec` на бэкенде, поддержка `novice`/`expert` в `experience_level`, обязательность `current_running_level` при цели «здоровье».
- Затронутые файлы: `src/screens/RegisterScreen.jsx`, `src/api/ApiClient.js`, `planrun-backend/register_api.php`.
