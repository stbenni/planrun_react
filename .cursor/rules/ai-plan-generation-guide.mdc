---
description: Формат генерации планов тренировок, структура JSON, типы дней, нормализация, отображение
globs: planrun-backend/planrun_ai/**
alwaysApply: false
---

# Гайд для ИИ: генерация тренировочных планов PlanRun

Этот документ описывает **точный формат**, в котором ИИ должен генерировать планы тренировок. ИИ выдаёт **только структурированные поля** (тип, дистанция, темп, упражнения), а PHP-нормализатор строит description, считает duration/distance и вычисляет даты.

---

## 1. Структура ответа (JSON) — СТРУКТУРИРОВАННЫЙ ФОРМАТ

ИИ возвращает **один JSON-объект** с ключом `weeks`. Никакого текста вне JSON. Поле `description` **НЕ генерируется** — код строит его автоматически. Даты **НЕ нужны** — код вычислит из week_number + индекса дня.

```json
{
  "weeks": [
    {
      "week_number": 1,
      "days": [
        {"type": "easy", "distance_km": 8, "pace": "6:00", "warmup_km": null, "cooldown_km": null, "reps": null, "interval_m": null, "interval_pace": null, "rest_m": null, "rest_type": null, "segments": null, "exercises": null, "duration_minutes": null, "notes": null, "is_key_workout": false}
      ]
    }
  ]
}
```

### Правила:
- В каждой неделе ровно **7 дней** (пн=индекс 0 ... вс=индекс 6)
- **Все 15 полей** присутствуют в каждом дне (неиспользуемые = `null`). Пропуск полей запрещён — JSON Schema `strict: true`
- `is_key_workout` (bool) обязателен для каждого дня
- `distance_km`, `duration_minutes`, `pace` — для простого бега; `warmup_km`, `reps`, `interval_m`, `interval_pace`, `rest_m`, `rest_type`, `cooldown_km` — для интервалов; `segments` — для фартлека; `exercises` — для ОФП/СБУ
- Нормализатор строит `description` и вычисляет `duration_minutes`, `distance_km` (для интервалов/фартлека), даты
- Промпт **не упоминает description** — LLM работает только со структурированными полями

---

## 2. Допустимые типы дней (`type`)

| type | Категория | Описание | is_key_workout |
|------|-----------|----------|----------------|
| `easy` | Бег | Лёгкий бег | `false` |
| `long` | Бег | Длительный бег | `true` |
| `tempo` | Бег | Темповый бег | `true` |
| `interval` | Бег | Интервалы | `true` |
| `fartlek` | Бег | Фартлек (структурированный) | `true` |
| `control` | Бег | Контрольный забег (тест-бег на результат) | `true` всегда |
| `race` | Бег | Соревнование | `true` |
| `other` | ОФП | Общая физическая подготовка | `false` |
| `sbu` | СБУ | Специальные беговые упражнения | `false` |
| `rest` | Отдых | День отдыха | `false` |
| `free` | Пусто | Свободный день | `false` |

### Алиасы (автоматически преобразовываются нормализатором):
- `easy_run` → `easy`
- `long_run`, `long-run` → `long`
- `ofp` → `other`
- `marathon` → `long`

Любой неизвестный тип превратится в `rest`.

### Ключевые тренировки (`is_key_workout`)
- Типы-ключевые по умолчанию: `interval`, `tempo`, `long`, `fartlek`, `race`, `control`
- LLM явно указывает `is_key_workout: true/false` для каждого дня
- Если LLM не указал — фолбэк на тип (см. `resolveIsKeyWorkout()` в нормализаторе)
- Между двумя ключевыми — минимум 1 день лёгкого бега или отдыха

### Контрольный забег (`control`)
- Тест-забег на дистанцию короче целевой, на максимальное усилие
- `pace` всегда `null` (бегун бежит на результат)
- `is_key_workout` всегда `true`
- Ставить каждые 3-4 недели, не в первые 2-3 и не в последние 2 недели плана
- DB ENUM: `control` — полноценный тип (не алиас)

---

## 3. Формат `description` (строится кодом)

> **ВАЖНО:** С переходом на структурированный формат ИИ **НЕ генерирует description**. Описание строит PHP-нормализатор (`plan_normalizer.php → buildDescriptionFromFields()`) из структурированных полей. Ниже описано, какие description получаются — для справки и для парсинга на фронте.

### 3.1 День отдыха (`rest`)

LLM выдаёт: `{"type": "rest"}` (все поля null).
Нормализатор ставит: `description = ""`, `distance_km = null`, `duration_minutes = null`.

**КРИТИЧНО:** Если в legacy-формате description содержит `бег`, `км`, `темп` — система переопределит тип на `easy`.

---

### 3.2 Простой бег (`easy`, `tempo`, `long`, `race`, `control`)

LLM выдаёт: `{"type": "easy", "distance_km": 8, "pace": "6:00", ..., "is_key_workout": false}`
Нормализатор строит: `"Лёгкий бег: 8 км или 0:48:00, темп 6:00"` + вычисляет `duration_minutes = 48`.

Для `control`: `{"type": "control", "distance_km": 3, "pace": null, ..., "is_key_workout": true}` → `"Контрольная тренировка: 3 км"`.

**Что парсит фронтенд (AddTrainingModal):**
- Дистанция: `/([\d.,]+)\s*км/` → число км
- Время: `/или\s+(\d{1,2}:\d{2}(?::\d{2})?)/` → формат `Ч:ММ:СС` или `ММ:СС`
- Темп: `/темп[:\s~]*(\d{1,2}:\d{2})/i` → формат `М:СС`
- Пульс: `/пульс[:\s]+(\d+)/i` → число

---

### 3.3 Интервалы (`interval`)

LLM выдаёт: `{"type": "interval", "warmup_km": 2, "reps": 5, "interval_m": 1000, "interval_pace": "4:20", "rest_m": 400, "rest_type": "jog", "cooldown_km": 1.5}`
Нормализатор строит: `"Разминка: 2 км. 5×1000м в темпе 4:20, пауза 400м трусцой. Заминка: 1.5 км"` + вычисляет `distance_km = 10.5`.

**Что парсит фронтенд:**
- `/Разминка[:\s]*([\d.,]+)\s*км/i` → разминка км
- `/(\d+)\s*[×x]\s*(\d+)\s*м/i` → повторы × дистанция м
- `/в темпе\s+(\d{1,2}:\d{2})/i` → темп интервала (первое вхождение!)
- `/пауза\s+(\d+)\s*м\s+(трусцой|ходьбой|отдых)/i` → пауза
- `/Заминка[:\s]*([\d.,]+)\s*км/i` → заминка км

**КРИТИЧНО:** В description «в темпе» отсутствует в разминке/заминке — это гарантируется кодом нормализатора.

---

### 3.4 Фартлек (`fartlek`)

LLM выдаёт: `{"type": "fartlek", "warmup_km": 2, "segments": [{"reps": 6, "distance_m": 200, "pace": "4:30", "recovery_m": 200, "recovery_type": "jog"}], "cooldown_km": 1.5}`
Нормализатор строит: `"Разминка: 2 км. 6×200м в темпе 4:30, восстановление 200м трусцой. Заминка: 1.5 км"` + вычисляет `distance_km`.

---

### 3.5 ОФП (`other`)

LLM выдаёт: `{"type": "other", "exercises": [{"name": "Приседания", "sets": 3, "reps": 10, "weight_kg": 20}, {"name": "Планка", "duration_min": 1}], "duration_minutes": 30}`
Нормализатор строит: `"Приседания — 3×10, 20 кг\nПланка — 1 мин"` (Unicode `—` и `×` подставляет код).

**Что парсит бэкенд (`description_parser.php`) для legacy-формата:**
- Разбивает по `\n` на строки
- Каждую строку делит по `—` или `-` на (название, параметры)
- Параметры: `/^(\d+)\s*×\s*(\d+)\s*(?:,\s*(\d+(?:[.,]\d+)?)\s*кг)?/u` → sets, reps, weight
- Или: `/^(\d+)\s*мин/u` → duration_sec

---

### 3.6 СБУ (`sbu`)

LLM выдаёт: `{"type": "sbu", "exercises": [{"name": "Бег с высоким подниманием бедра", "distance_m": 30}, {"name": "Захлёст голени", "distance_m": 50}]}`
Нормализатор строит: `"Бег с высоким подниманием бедра — 30 м\nЗахлёст голени — 50 м"`

---

## 4. Библиотека упражнений (`exercise_library`)

### 4.1 Таблица `exercise_library`

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | INT PK | Идентификатор |
| `name` | VARCHAR(255) | Название (уникально по `idx_name`) |
| `category` | VARCHAR(64) | Категория: `run`, `ofp`, `sbu` |
| `default_sets` | INT NULL | Подходы по умолчанию |
| `default_reps` | INT NULL | Повторы по умолчанию |
| `default_distance_m` | INT NULL | Дистанция по умолчанию (м) |
| `default_duration_sec` | INT NULL | Длительность по умолчанию (сек) |

### 4.2 Текущий каталог упражнений

#### ОФП (category: `ofp`) — 12 упражнений:

| Название | Подходы | Повторы | Длительность |
|----------|---------|---------|-------------|
| Жим ногами в тренажере | 3 | 15 | — |
| Приседания со штангой | 4 | 12 | — |
| Жим лежа | 4 | 10 | — |
| Тяга верхнего блока | 3 | 12 | — |
| Жим гантелей сидя | 3 | 12 | — |
| Разгибание ног в тренажере | 3 | 15 | — |
| Сгибание ног в тренажере | 3 | 15 | — |
| Планка | 3 | — | 60 сек |
| Подъемы на носки | 3 | 20 | — |
| Отжимания | 3 | 15 | — |
| Подтягивания | 3 | 10 | — |
| Пресс | 3 | 20 | — |

#### СБУ (category: `sbu`) — 10 упражнений:

| Название | Повторы | Дистанция |
|----------|---------|-----------|
| Высокий подъем бедра (А-скак) | 4 | 30 м |
| Захлест голени (Б-скак) | 4 | 30 м |
| Бег с высоким подниманием бедра | 4 | 30 м |
| Многоскоки | 3 | 50 м |
| Бег спиной вперед | 3 | 30 м |
| Бег боком (приставными шагами) | 3 | 30 м |
| Бег с подскоками | 3 | 30 м |
| Олений бег | 3 | 30 м |
| Бег с подниманием прямых ног | 3 | 30 м |
| Бег с выпрыгиванием | 3 | 30 м |

#### Бег (category: `run`) — 10 записей (используются как справочные):

Легкий бег, Темповый бег, Интервалы, Длительный бег, Фартлек, Разминка, Заминка, Бег в гору, Бег по пересеченной местности, Контрольная тренировка.

### 4.3 Как ИИ должен использовать библиотеку

**При генерации ОФП/СБУ лучше использовать названия из библиотеки** — тогда фронтенд распознает их и свяжет с записью в `exercise_library`:

- Фронтенд ищет совпадение по имени: `libraryExercises.find(e => namePart === e.name || namePart.startsWith(e.name) || e.name.startsWith(namePart))`
- Если найдено → упражнение привязывается к библиотечному, подставляются дефолтные значения
- Если не найдено → создаётся **кастомное упражнение** (см. раздел 5)

**Рекомендация:** Для 80% упражнений хватит библиотеки. Для оставшихся — используй понятные названия с правильным форматом.

---

## 5. Кастомные упражнения

### 5.1 Как возникают

Кастомное упражнение — это любое упражнение, **название которого не совпадает** с записью в `exercise_library`.

**Источники:**
1. **ИИ-генерация**: если ИИ пишет в description `"Выпады вперёд — 3×12"`, а в библиотеке нет «Выпады вперёд» → кастомное
2. **Ручное добавление**: пользователь может добавить упражнение через форму в `AddTrainingModal` или `ResultModal`

### 5.2 Как хранятся

В `training_day_exercises` — точно так же, как библиотечные, но с `exercise_id = NULL`:

```
| exercise_id | category | name              | sets | reps | distance_m | weight_kg |
|-------------|----------|-------------------|------|------|------------|-----------|
| NULL        | ofp      | Выпады вперёд     | 3    | 12   | NULL       | NULL      |
| 5           | ofp      | Жим гантелей сидя | 3    | 12   | NULL       | NULL      |
```

### 5.3 Рекомендации для ИИ по кастомным упражнениям

- **Предпочитать названия из библиотеки** (раздел 4.2) — они распознаются фронтендом
- Если нужно специфическое упражнение — писать **короткое, понятное название** без пояснений в скобках
- Не писать `"Выпады (с гантелями, 3 подхода по 12)"` — вес и подходы идут через `—`: `"Выпады — 3×12, 10 кг"`
- Не придумывать экзотику — базовые упражнения лучше для парсинга

**Примеры кастомных ОФП (распарсятся корректно):**
```
Выпады — 3×12
Ягодичный мостик — 3×15
Берпи — 3×10
Боковая планка — 1 мин
```

**Примеры кастомных СБУ (распарсятся корректно):**
```
Прыжки в длину — 30 м
Семенящий бег — 50 м
Бег на прямых ногах — 40 м
```

---

## 6. Конструктор планирования и редактирования (`AddTrainingModal`)

### 6.1 Три режима работы

| Режим | Условие | Что происходит |
|-------|---------|----------------|
| **Новый план** | нет `initialData` и нет `editResultData` | Шаг 1 → выбор категории, Шаг 2 → заполнение формы, сохранение через `addTrainingDayByDate` |
| **Редактирование плана** | есть `initialData.id` | Шаг 2 сразу, форма заполнена из description, сохранение через `updateTrainingDay` |
| **Редактирование результата** | есть `editResultData.date` | Шаг 2 сразу, форма заполнена из результата, сохранение через `saveResult` |

### 6.2 Шаг 1 — Выбор категории

Три карточки:
- **Бег** (running) → типы: easy, tempo, long, interval, fartlek, race
- **ОФП** (ofp) → тип: other
- **СБУ** (sbu) → тип: sbu

### 6.3 Шаг 2 — Калькулятор бега (easy/tempo/long/race)

4 поля с автопересчётом:

| Поле | Формат | Пример |
|------|--------|--------|
| Дистанция | число км | `10` |
| Время | ЧЧ:ММ:СС | `0:50:00` |
| Темп | М:СС / км | `5:00` |
| Пульс | число | `140` |

**Логика пересчёта:**
- Изменение **темпа** или **дистанции** → пересчёт **времени** (`время = дистанция × темп`)
- Изменение **времени** → пересчёт **темпа** (`темп = время / дистанция`)
- Пульс — информационное поле, не участвует в расчётах

**Генерация description:**
```
Легкий бег: 10 км или 0:50:00, темп 5:00, пульс 140
```

### 6.4 Конструктор интервалов

9 полей:

| Поле | Описание | Пример |
|------|----------|--------|
| Разминка (км) | Дистанция разминки | `2` |
| Разминка темп | М:СС | `6:00` |
| Количество повторов | Число | `5` |
| Дистанция серии (м) | Метры | `1000` |
| Темп серии | М:СС | `4:30` |
| Дистанция паузы (м) | Метры | `400` |
| Тип паузы | трусцой/ходьбой/отдых | `трусцой` |
| Заминка (км) | Дистанция заминки | `2` |
| Заминка темп | М:СС | `6:00` |

**Общая дистанция:** `разминка + повторы × (серия + пауза) / 1000 + заминка`

**Генерация description:**
```
Разминка: 2 км в темпе 6:00. 5×1000м в темпе 4:30, пауза 400м трусцой. Заминка: 2 км в темпе 6:00
```

### 6.5 Конструктор фартлека

Базовые поля + массив сегментов:
- Разминка (км), Заминка (км)
- Каждый сегмент: повторы, дистанция ускорения (м), темп ускорения, дистанция восстановления (м), тип восстановления

**Генерация description:**
```
Разминка: 2 км. 4×200м в темпе 4:00, восстановление 200м трусцой. 3×400м в темпе 3:45, восстановление 300м ходьбой. Заминка: 2 км
```

### 6.6 Конструктор ОФП

1. Загружается библиотека (API `list_exercise_library`, фильтр по category: `ofp`, `other`, `strength`)
2. Каждое упражнение — чекбокс + поля sets × reps + weight
3. Дефолтные значения подставляются из библиотеки (`default_sets`, `default_reps`)
4. Можно добавить **кастомное упражнение**: имя + sets + reps + weight

**Генерация description:**
```
Приседания со штангой — 4×12, 30 кг
Отжимания — 3×15
Планка — 1 мин
Выпады — 3×10
```

### 6.7 Конструктор СБУ

1. Загружается библиотека (фильтр по category: `sbu`, `other`)
2. Каждое упражнение — чекбокс + поле дистанции (м), дефолт из `default_distance_m` или `30`
3. Можно добавить кастомное: имя + дистанция

**Генерация description:**
```
Высокий подъем бедра (А-скак) — 30 м
Захлест голени (Б-скак) — 30 м
Многоскоки — 50 м
```

### 6.8 Парсинг description при редактировании (description → поля формы)

При открытии в режиме редактирования `description` разбирается регулярками обратно в поля:

**Бег:** `/(\d+)\s*км/`, `/или\s+(\d{1,2}:\d{2})/`, `/темп\s+(\d{1,2}:\d{2})/`, `/пульс\s+(\d+)/`

**Интервалы:** `/Разминка\s*([\d]+)\s*км/`, `/(\d+)×(\d+)м/`, `/пауза\s+(\d+)м\s+(трусцой|ходьбой)/`, `/Заминка\s*([\d]+)\s*км/`

**ОФП/СБУ:** Построчно, каждая строка делится по `—` → (название, параметры). Название матчится с `libraryExercises` → если найдено, выбирается в чекбоксе; если нет → создаётся кастомное. Параметры парсятся: `(\d+)×(\d+)` → sets/reps, `(\d+)\s*кг` → weight, `(\d+)\s*м` → distance.

**Почему важно для ИИ:** если description не соответствует формату — при редактировании пользователь увидит пустые поля калькулятора и только текст в textarea.

---

## 7. Запись выполнения тренировок (`ResultModal`)

### 7.1 Что это

Модалка для записи факта выполнения запланированной тренировки. Открывается из `DayModal` кнопкой «Выполнено».

### 7.2 Определение блоков для показа

- **hasRun**: `planDays.some(pd => ['easy','tempo','long','interval','fartlek','race','control'].includes(pd.type))`
- **hasOfpPlan**: `planDays.some(pd => pd.type === 'other') || dayExercises.filter(ex => ex.category === 'ofp').length > 0`
- **hasSbuPlan**: `planDays.some(pd => pd.type === 'sbu') || dayExercises.filter(ex => ex.category === 'sbu').length > 0`

**Важно:** Блок «Бег» в текущей версии **не отображается автоматически** для беговых дней — пользователь должен добавить его вручную через «+ Добавить тип». Блоки ОФП/СБУ показываются автоматически, если есть упражнения в плане.

### 7.3 Блок ОФП: плановые vs фактические

Для каждого ОФП-упражнения из `dayExercises` показываются:
- **Плановые** значения (sets, reps, weight) — из плана, только для чтения
- **Фактические** поля ввода (doneSets, doneReps, doneWeight) — заполняет пользователь

Если пользователь не заполнил фактические — при сохранении используются плановые значения.

### 7.4 Блок СБУ: плановые vs фактические

Для каждого СБУ-упражнения:
- **Плановая дистанция** (из плана)
- **Фактическая дистанция** — поле ввода (м)

### 7.5 Дополнительные упражнения

Пользователь может добавить упражнения, которых нет в плане:
- Через «+ Добавить тип тренировки» — добавляет целый блок (бег/ОФП/СБУ)
- Через форму внутри блока — добавляет отдельные упражнения (кастомные)

### 7.6 `buildNotes()` — сериализация результата в текст

Все данные об упражнениях собираются в **одно текстовое поле `notes`** (таблица `workout_log`):

```
Текст заметки пользователя
ОФП: Приседания со штангой 4×12, 30 кг
ОФП: Планка 3×60 сек
СБУ: Бег с высоким подниманием бедра 30 м
СБУ: Многоскоки 50 м
```

**Формат каждой строки:**
- ОФП: `"ОФП: {Название} {sets}×{reps}[, {weight} кг]"`
- СБУ: `"СБУ: {Название} {distance} м"` (или `"X.X км"` если ≥1000 м)

**Порядок сборки:**
1. Плановые ОФП-упражнения (не удалённые): `done`-значения → fallback на `planned`
2. Плановые СБУ-упражнения (не удалённые): `doneDistanceM` → fallback на `plannedDistanceM`
3. Дополнительные упражнения (кастомные)
4. Текст заметки пользователя

### 7.7 Что сохраняется в `workout_log`

```javascript
{
  date: "2026-03-04",
  week: 1,
  day: "wed",
  activity_type_id: 1,        // всегда 1 (бег) — неважно что за тренировка
  result_distance: 10.5,      // км, из поля distance (или null)
  result_time: "0:52:00",     // из поля time (или null)
  avg_heart_rate: 145,        // из поля heartRate (или null)
  notes: "ОФП: Приседания 4×12, 30 кг\nСБУ: Многоскоки 50 м",
  is_successful: true
}
```

**Важно для ИИ:** Все структурированные данные об ОФП/СБУ упражнениях **сериализуются в текст `notes`**. Обратный парсинг `notes` в структурированные поля — сложная задача. При редактировании результата фронтенд восстанавливает только беговые поля (distance, time, pace); ОФП/СБУ из notes не парсятся обратно в чекбоксы.

---

## 8. Нормализатор плана (`plan_normalizer.php`)

### 8.1 Что это

Standalone-функция `normalizeTrainingPlan($rawPlan, $startDate)` в `planrun-backend/planrun_ai/plan_normalizer.php`.

Принимает **сырой JSON от ИИ** и возвращает **чистый массив**, готовый для:
- Сохранения в БД (используется в `plan_saver.php`)
- Отправки на фронтенд как preview
- Валидации и логирования

### 8.2 Что делает нормализатор

1. **Нормализация типов**: `easy_run` → `easy`, `ofp` → `other`, `long-run` → `long`, неизвестные → `rest`
2. **Коррекция rest-дней**: если `type=rest`, но есть дистанция или беговые слова в описании → `easy`
3. **Генерация description**: если описание пустое, но есть `distance_km` → `"Бег X км в темпе Y"`
4. **Расчёт дат**: по `startDate` и индексу дня вычисляет правильные даты (пн→вс)
5. **Парсинг ОФП/СБУ**: описание разбивается на структурированные упражнения через `description_parser.php`
6. **Создание упражнений**: для каждого дня формирует массив `exercises[]` с полями category, name, sets, reps, distance_m, duration_sec, weight_kg
7. **Расчёт объёма**: суммирует `distance_km` по неделе → `total_volume`
8. **Сбор warnings**: все переопределения типов, проблемы с форматом → массив `warnings[]`

### 8.3 Формат выхода

```php
[
    'weeks' => [
        [
            'week_number' => 1,
            'start_date'  => '2026-03-02',
            'total_volume' => 31.0,
            'days' => [
                [
                    'date'            => '2026-03-02',
                    'day_of_week'     => 1,
                    'type'            => 'easy',
                    'description'     => 'Лёгкий бег: 5 км или 0:30:00, темп 6:00',
                    'distance_km'     => 5.0,
                    'duration_minutes' => 30,
                    'pace'            => '6:00',
                    'is_key_workout'  => false,
                    'exercises'       => [
                        [
                            'category'     => 'run',
                            'name'         => 'Бег 5.0 км',
                            'distance_m'   => 5000,
                            'duration_sec' => 1800,
                            'sets' => null, 'reps' => null, 'weight_kg' => null,
                            'pace' => '6:00', 'notes' => '...', 'order_index' => 0,
                        ]
                    ],
                ],
                // ... остальные дни
            ],
        ],
    ],
    'warnings' => [
        "Неделя 1, 2026-03-08: тип 'rest' переопределён в 'easy'"
    ],
]
```

### 8.4 Использование

```php
require_once 'planrun_ai/plan_normalizer.php';

// Получить нормализованный JSON без сохранения в БД:
$normalized = normalizeTrainingPlan($rawAiPlan, '2026-03-02');

// Сохранить в БД (plan_saver.php использует normalizer внутри):
saveTrainingPlan($db, $userId, $rawAiPlan, '2026-03-02');
```

---

## 9. Как данные хранятся в БД (детали)

### 8.1 Структура

```
training_plan_weeks
  └── training_plan_days (type, description, date, is_key_workout)
        └── training_day_exercises (exercise_id?, category, name, sets, reps, distance_m, duration_sec, weight_kg, notes, order_index)
              └── exercise_library (name, category, default_*) — через exercise_id (опционально)

workout_log (training_date, distance_km, result_time, pace, notes, avg_heart_rate, ...)
```

### 8.2 Что создаётся при сохранении плана

1. **Для беговых дней** (easy, long, tempo, interval, fartlek, race, control) с `distance_km > 0`:
   - Запись в `training_day_exercises` с `category='run'`, `name="Бег X.X км"`, `distance_m`, `duration_sec`

2. **Для ОФП/СБУ** (other, sbu):
   - `description` парсится построчно через `description_parser.php`
   - Каждое упражнение → отдельная запись в `training_day_exercises` с `category='ofp'`/`'sbu'`
   - `exercise_id = NULL` (план не связывает с библиотекой — связь устанавливается только на фронте по совпадению имени)
   - Если парсинг не удался — упражнение сохраняется с `name=строка`, без sets/reps/distance

3. **Для отдыха** (rest):
   - Только `training_plan_days`, упражнения не создаются
   - Описание принудительно очищается

### 8.3 Ключевые тренировки

Типы, для которых `is_key_workout` по умолчанию `true` (если LLM не указал явно):
- `interval`, `tempo`, `long`, `fartlek`, `race`, `control`

LLM указывает `is_key_workout` явно для каждого дня. Нормализатор использует `resolveIsKeyWorkout()`: приоритет — явное значение от LLM, фолбэк — тип из списка выше.

---

## 10. Как фронтенд отображает данные

### 10.1 Карточка дня (WorkoutCard)
- Показывает `TYPE_NAMES[type]` как заголовок
- Рендерит `description` через `dangerouslySetInnerHTML`
- Цвет иконки зависит от `type`

### 10.2 Модалка дня (DayModal)
- Если есть `dayExercises` — показывает структурированные карточки упражнений (name, sets×reps, weight, distance, duration)
- Если нет — показывает `planHtml` как HTML

### 10.3 API `getDay` возвращает:
```javascript
{
  planHtml: "...",           // HTML для отображения (legacy)
  planDays: [{               // Массив планов на день
    id, type, description, is_key_workout
  }],
  dayExercises: [{           // Структурированные упражнения
    id, exercise_id, category, name, sets, reps,
    distance_m, duration_sec, weight_kg, pace, notes, order_index
  }],
  workouts: [{               // Выполненные тренировки
    distance_km, result_time, avg_pace, notes, is_manual
  }]
}
```

---

## 11. Частые ошибки ИИ и как их избежать

| Ошибка | Последствие | Как правильно |
|--------|------------|---------------|
| Пропуск поля в JSON дне | Ошибка structured output (strict: true) | Все 15 полей в каждом дне, неиспользуемые = `null` |
| Нет `is_key_workout` | Фолбэк на тип, но может быть неточным | Явно указывать `true`/`false` |
| `type: "rest"` с `distance_km > 0` | Переопределится в `easy` | Для отдыха: все поля `null` |
| Генерация `description` | Нормализатор всё равно перезапишет | Не генерировать — код строит сам |
| `distance_km` для interval/fartlek | Будет проигнорирован | Ставить `null` — код посчитает |
| `pace: "5:30/км"` | Парсер не найдёт | `"5:30"` без `/км` |
| Тип `"ofp"` | Преобразуется в `"other"` | Сразу `"other"` |
| `control` с `pace` | Контрольный забег на результат, темп не назначается | `pace: null` |
| Две ключевые подряд | Перетренировка | Минимум 1 день лёгкого/отдыха между ними |
| Названия упражнений не из библиотеки | Создадутся как кастомные, без связи с library | По возможности использовать точные названия из раздела 4.2 |

---

## 12. Полный пример идеального плана (одна неделя, новый структурированный формат)

Все 15 полей в каждом дне, неиспользуемые = `null`. Нет `description`, нет `date` — код вычислит.

```json
{
  "weeks": [
    {
      "week_number": 1,
      "days": [
        {"type":"easy","distance_km":5,"pace":"6:00","warmup_km":null,"cooldown_km":null,"reps":null,"interval_m":null,"interval_pace":null,"rest_m":null,"rest_type":null,"segments":null,"exercises":null,"duration_minutes":null,"notes":null,"is_key_workout":false},
        {"type":"rest","distance_km":null,"pace":null,"warmup_km":null,"cooldown_km":null,"reps":null,"interval_m":null,"interval_pace":null,"rest_m":null,"rest_type":null,"segments":null,"exercises":null,"duration_minutes":null,"notes":null,"is_key_workout":false},
        {"type":"interval","distance_km":null,"pace":null,"warmup_km":2,"cooldown_km":1.5,"reps":5,"interval_m":1000,"interval_pace":"4:30","rest_m":400,"rest_type":"jog","segments":null,"exercises":null,"duration_minutes":null,"notes":null,"is_key_workout":true},
        {"type":"other","distance_km":null,"pace":null,"warmup_km":null,"cooldown_km":null,"reps":null,"interval_m":null,"interval_pace":null,"rest_m":null,"rest_type":null,"segments":null,"exercises":[{"name":"Приседания со штангой","sets":4,"reps":12,"weight_kg":30,"distance_m":null,"duration_min":null},{"name":"Отжимания","sets":3,"reps":15,"weight_kg":null,"distance_m":null,"duration_min":null},{"name":"Планка","sets":null,"reps":null,"weight_kg":null,"distance_m":null,"duration_min":1}],"duration_minutes":40,"notes":null,"is_key_workout":false},
        {"type":"easy","distance_km":6,"pace":"6:00","warmup_km":null,"cooldown_km":null,"reps":null,"interval_m":null,"interval_pace":null,"rest_m":null,"rest_type":null,"segments":null,"exercises":null,"duration_minutes":null,"notes":null,"is_key_workout":false},
        {"type":"sbu","distance_km":null,"pace":null,"warmup_km":null,"cooldown_km":null,"reps":null,"interval_m":null,"interval_pace":null,"rest_m":null,"rest_type":null,"segments":null,"exercises":[{"name":"Высокий подъем бедра (А-скак)","sets":null,"reps":null,"weight_kg":null,"distance_m":30,"duration_min":null},{"name":"Захлест голени (Б-скак)","sets":null,"reps":null,"weight_kg":null,"distance_m":30,"duration_min":null},{"name":"Многоскоки","sets":null,"reps":null,"weight_kg":null,"distance_m":50,"duration_min":null}],"duration_minutes":null,"notes":null,"is_key_workout":false},
        {"type":"long","distance_km":12,"pace":"6:30","warmup_km":null,"cooldown_km":null,"reps":null,"interval_m":null,"interval_pace":null,"rest_m":null,"rest_type":null,"segments":null,"exercises":null,"duration_minutes":null,"notes":null,"is_key_workout":true}
      ]
    }
  ]
}
```

---

## 13. Чеклист перед генерацией

- [ ] 7 дней в каждой неделе
- [ ] Все 15 полей в каждом дне (неиспользуемые = `null`)
- [ ] `is_key_workout` (bool) указан для каждого дня
- [ ] `rest` дни — все поля `null`, `is_key_workout: false`
- [ ] Беговые дни — `distance_km > 0`, `pace` в формате `M:SS`
- [ ] Контрольный забег — `type: "control"`, `pace: null`, `is_key_workout: true`
- [ ] ОФП — `type: "other"`, `exercises` массив, названия по возможности из библиотеки (раздел 4.2)
- [ ] СБУ — `type: "sbu"`, `exercises` массив, названия по возможности из библиотеки (раздел 4.2)
- [ ] Интервалы: `distance_km: null` (код посчитает), `interval_m` в метрах
- [ ] Фартлек: `distance_km: null` (код посчитает), `segments` массив
- [ ] Нет поля `description` (строит нормализатор)
- [ ] Нет поля `date` (вычисляет нормализатор из week_number + индекса)
- [ ] JSON валидный, без комментариев
- [ ] Между двумя ключевыми тренировками — минимум 1 день лёгкого бега или отдыха

## 14. Защита при сохранении (`plan_saver.php`)

- Вся операция DELETE + INSERT обёрнута в **транзакцию** (`begin_transaction` / `commit` / `rollback`)
- При ошибке — откат, старый план остаётся нетронутым
- Тип дня проверяется перед INSERT: если не в `SAVER_ALLOWED_TYPES` → fallback на `rest`
- `bind_param` типы: `distance_m` → `int`, `sets`/`reps` → `int`, `duration_sec` → `int`
